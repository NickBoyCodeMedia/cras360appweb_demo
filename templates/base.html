{% load static %}
<!DOCTYPE html>
<html lang="pt-br" data-user-perfil="{{ user.perfil }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRAS360{% endblock %}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="icon" href="{% static 'imagens/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/notificacoes.css' %}">
    <style>
        .navbar-cras {
            background-color: #28a745 !important;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: 600;
        }

        .nav-link {
            font-weight: 500;
        }

        .dropdown-menu {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dropdown-item:hover {
            background-color: #e9f7ef;
        }

        .navbar-icon {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .navbar-icon:hover {
            color: #fff;
        }

        .navbar-clock {
            color: rgba(255, 255, 255, 0.9);
            padding: .5rem 1rem;
            font-size: 0.9rem;
            display: inline-block;
        }

        .badge-notify {
            background-color: #dc3545;
            position: absolute;
            top: 0;
            right: 0;
            font-size: 0.6rem;
            transform: translate(25%, -25%);
        }

        .icon-container {
            position: relative;
            display: inline-block;
            margin-right: 1rem;
        }

        /* Novo estilo para corrigir o dropdown de ajuda */
        .nav-item .dropdown-menu {
            position: absolute;
            right: 0;
            left: auto;
            top: 100%;
            margin-top: 0.125rem;
        }

        /* Corrigir posicionamento específico do dropdown de ajuda */
        #helpDropdown+.dropdown-menu {
            transform: none !important;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Banner Versão Demo -->
    <div
        style="background-color: #ffc107; color: #000; text-align: center; padding: 5px; font-weight: bold; font-size: 0.9rem; border-bottom: 1px solid #e0a800;">
        <i class="fas fa-exclamation-triangle"></i> VERSÃO DE DEMONSTRAÇÃO - CRAS360 (Portfólio)
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark navbar-cras">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">
                <i class="fas fa-home"></i> CRAS360
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">


                {% if user.is_authenticated %}
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <span class="navbar-clock" id="navbar-clock">
                            <i class="far fa-clock"></i> <span id="current-time"></span>
                        </span>
                    </li>
                    <li class="nav-item dropdown notificacoes-nav-item">
                        <a class="nav-link dropdown-toggle" href="#" id="notificacoesDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-bell"></i>
                            <span id="badge-notificacoes" class="badge-notificacoes" style="display: none;">0</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="notificacoesDropdown">
                            <h6 class="dropdown-header">Notificações</h6>
                            <div id="notificacoes-lista" class="notificacoes-lista">
                                <div class="dropdown-item text-center text-muted">
                                    Nenhuma notificação
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item text-center" href="#" id="btn-ver-todas-notificacoes">
                                Ver todas
                            </a>
                        </div>
                    </li>
                    <li class="nav-item position-relative">
                        <a class="nav-link navbar-icon" href="#" id="helpDropdown" role="button" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-info-circle"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="helpDropdown">
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-question-circle text-primary"></i> Ajuda
                            </a>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-book text-success"></i> Manual do Sistema
                            </a>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-phone text-info"></i> Suporte Técnico
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-info-circle text-secondary"></i> Sobre o CRAS360
                            </a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-user-circle"></i> {{ user.nome_completo }}
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
                            <!-- Adicionar link para o módulo de recepção aqui também (nos links rápidos) -->
                            {% if user.is_superuser or user.perfil == 'Recepção' %}
                            <a class="dropdown-item" href="{% url 'recepcao_index' %}">
                                <i class="fas fa-door-open text-success"></i> Módulo de Recepção
                            </a>
                            <div class="dropdown-divider"></div>
                            {% endif %}

                            <a class="dropdown-item" href="#">
                                <i class="fas fa-id-card text-primary"></i> Meu Perfil
                            </a>
                            <a class="dropdown-item" href="{% url 'dashboard' %}">
                                <i class="fas fa-tachometer-alt text-success"></i> Painel Inicial
                            </a>

                            {% if user.perfil in 'Auxiliar Administrativo,Coordenador,Desenvolvedor' %}
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-cogs text-info"></i> Módulo Administrativo
                            </a>
                            <a class="dropdown-item" href="#">
                                <i class="fas fa-file-alt text-info"></i> Ofícios e Documentos
                            </a>
                            {% endif %}

                            {% if user.is_superuser or 'gestores' in user.groups.all|stringformat:"s" %}
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{% url 'gestao:gestao_municipal' %}">
                                <i class="fas fa-chart-pie text-success"></i> Gestão Municipal
                            </a>
                            {% endif %}

                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt text-danger"></i> Sair
                            </a>
                        </div>
                    </li>
                </ul>
                {% else %}
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">Entrar</a>
                    </li>
                </ul>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if messages %}
        {% for message in messages %}
        <div
            class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <!-- Modal para exibir todas as notificações -->
    <div class="modal fade" id="todasNotificacoesModal" tabindex="-1" role="dialog"
        aria-labelledby="todasNotificacoesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="todasNotificacoesModalLabel"><i class="fas fa-bell"></i> Todas as
                        Notificações</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="lista-todas-notificacoes">
                        <!-- Notificações serão inseridas aqui -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        // Atualização do relógio da barra de navegação
        function atualizarRelogio() {
            const agora = new Date();
            const horas = agora.getHours().toString().padStart(2, '0');
            const minutos = agora.getMinutes().toString().padStart(2, '0');
            document.getElementById('current-time').textContent = `${horas}:${minutos}`;
        }

        // Atualizar relógio a cada minuto
        setInterval(atualizarRelogio, 60000);
        atualizarRelogio();
    </script>
    <script>
        // Dados do usuário para notificações
        const USER_ID = "{{ request.user.id }}";
        const USER_NOME = "{{ request.user.nome_completo }}";
    </script>
    <script src="{% static 'js/notificacoes.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar o dropdown de notificações
            document.getElementById('notificacoesDropdown').addEventListener('click', function () {
                notificacoes.limparContador();
                atualizarListaNotificacoes();
            });

            // Manipulador para botão "Ver todas"
            document.getElementById('btn-ver-todas-notificacoes').addEventListener('click', function (e) {
                e.preventDefault();
                $('#todasNotificacoesModal').modal('show');
                atualizarTodasNotificacoes();
            });

            // Função para atualizar a lista dropdown de notificações
            function atualizarListaNotificacoes() {
                const listaEl = document.getElementById('notificacoes-lista');
                const historico = notificacoes.obterHistorico().slice(0, 5); // Pegar apenas as 5 mais recentes

                if (historico.length === 0) {
                    listaEl.innerHTML = '<div class="dropdown-item text-center text-muted">Nenhuma notificação</div>';
                    return;
                }

                listaEl.innerHTML = '';

                historico.forEach(notif => {
                    const item = document.createElement('a');
                    item.className = 'dropdown-item';
                    item.href = '#';

                    let icone = 'fa-bell';
                    switch (notif.tipo_notificacao) {
                        case 'urgente':
                            icone = 'fa-exclamation-triangle text-danger';
                            break;
                        case 'atendimento_aguardando':
                            icone = 'fa-user-clock text-success';
                            break;
                        case 'informacao':
                            icone = 'fa-info-circle text-info';
                            break;
                    }

                    item.innerHTML = `
                        <div>
                            <div class="d-flex align-items-center">
                                <i class="fas ${icone} mr-2"></i>
                                <strong class="mr-auto">${notif.tipo_notificacao === 'urgente' ? 'URGENTE' : 'Notificação'}</strong>
                                <small class="text-muted">${formatarTempo(notif.data_hora)}</small>
                            </div>
                            <div class="mt-2">
                                <p class="mb-0"><small>De: ${notif.origem}</small></p>
                                ${notif.beneficiario ? `<p class="mb-0"><small>Beneficiário: ${notif.beneficiario}</small></p>` : ''}
                                <p class="mb-0">${notif.mensagem.substring(0, 50)}${notif.mensagem.length > 50 ? '...' : ''}</p>
                            </div>
                        </div>
                    `;

                    listaEl.appendChild(item);
                });
            }

            // Função para atualizar modal com todas as notificações
            function atualizarTodasNotificacoes() {
                const listaEl = document.getElementById('lista-todas-notificacoes');
                const historico = notificacoes.obterHistorico();

                if (historico.length === 0) {
                    listaEl.innerHTML = '<div class="text-center text-muted p-3">Nenhuma notificação</div>';
                    return;
                }

                listaEl.innerHTML = '';

                historico.forEach(notif => {
                    const item = document.createElement('div');
                    item.className = 'list-group-item list-group-item-action';

                    let classeNotif = '';
                    let icone = 'fa-bell';

                    switch (notif.tipo_notificacao) {
                        case 'urgente':
                            classeNotif = 'list-group-item-danger';
                            icone = 'fa-exclamation-triangle';
                            break;
                        case 'atendimento_aguardando':
                            classeNotif = 'list-group-item-success';
                            icone = 'fa-user-clock';
                            break;
                        case 'informacao':
                            classeNotif = 'list-group-item-info';
                            icone = 'fa-info-circle';
                            break;
                    }

                    item.classList.add(classeNotif);

                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                <i class="fas ${icone} mr-2"></i>
                                ${notif.tipo_notificacao === 'urgente' ? 'URGENTE' : notif.tipo_notificacao.replace('_', ' ').toUpperCase()}
                            </h5>
                            <small>${formatarDataCompleta(notif.data_hora)}</small>
                        </div>
                        <p class="mb-1"><strong>De:</strong> ${notif.origem}</p>
                        ${notif.beneficiario ? `<p class="mb-1"><strong>Beneficiário:</strong> ${notif.beneficiario}</p>` : ''}
                        <p class="mb-1">${notif.mensagem}</p>
                    `;

                    listaEl.appendChild(item);
                });
            }

            // Formatar tempo relativo (ex: "há 5 minutos")
            function formatarTempo(dataHoraISO) {
                const data = new Date(dataHoraISO);
                const agora = new Date();
                const diferenca = Math.floor((agora - data) / 1000); // diferença em segundos

                if (diferenca < 60) return 'agora';
                if (diferenca < 3600) return `há ${Math.floor(diferenca / 60)} min`;
                if (diferenca < 86400) return `há ${Math.floor(diferenca / 3600)} h`;
                return `há ${Math.floor(diferenca / 86400)} d`;
            }

            // Formatar data completa
            function formatarDataCompleta(dataHoraISO) {
                const data = new Date(dataHoraISO);
                return data.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        });
    </script>

    <!-- Inclui o script para converter automaticamente para maiúsculas -->
    <script src="{% static 'js/uppercase-converter.js' %}"></script>

    {% block extra_js %}{% endblock %}
</body>

</html>