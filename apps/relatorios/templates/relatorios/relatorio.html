{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Relatórios</h1>
    <p>Selecione o tipo de relatório e aplique os filtros desejados.</p>

    <!-- Seleção de tipo de relatório -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
y text-white">
            <h5 class="mb-0">Tipo de Relatório</h5>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="tipo-relatorio">Escolha o tipo de relatório:</label>
                <select id="tipo-relatorio" class="form-control">
                    <option value="">Selecione...</option>
                    <option value="scfv">SCFV</option>
                    <option value="paif">PAIF</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Filtros dinâmicos -->
    <div id="filtros-container" style="display: none;">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Filtros</h5>
            </div>
            <div class="card-body">
                <form id="filtros-form">
                    <!-- Filtros dinâmicos serão inseridos aqui via JavaScript -->
                </form>
            </div>
        </div>
    </div>

    <!-- Botões de ação -->
    <div id="acoes-container" style="display: none;">
        <button id="btn-gerar-relatorio" class="btn btn-primary">Gerar Relatório</button>
        <button id="btn-exportar-pdf" class="btn btn-danger">Exportar PDF</button>
        <button id="btn-exportar-excel" class="btn btn-success">Exportar Excel</button>
    </div>

    <!-- Resultados -->
    <div id="resultados-container" class="mt-4" style="display: none;">
        <h2>Resultados</h2>
        <div class="table-responsive">
            <table id="tabela-resultados" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <!-- Cabeçalhos dinâmicos -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Dados dinâmicos -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoRelatorio = document.getElementById('tipo-relatorio');
        
        tipoRelatorio.addEventListener('change', function () {
            const tipo = this.value;
            const filtrosContainer = document.getElementById('filtros-container');
            const acoesContainer = document.getElementById('acoes-container');
            const resultadosContainer = document.getElementById('resultados-container');
            const filtrosForm = document.getElementById('filtros-form');
    
            filtrosContainer.style.display = tipo ? 'block' : 'none';
            acoesContainer.style.display = tipo ? 'block' : 'none';
            resultadosContainer.style.display = 'none';
            filtrosForm.innerHTML = '';
    
            if (tipo === 'scfv') {
                // Redirecionar para a página específica SCFV
                window.location.href = "{% url 'relatorios:scfv' %}";
            } else if (tipo === 'paif') {
                // Redirecionar para a página específica PAIF
                window.location.href = "{% url 'relatorios:paif' %}";
            }
        });
    
        // Botões de ação
        document.getElementById('btn-gerar-relatorio').addEventListener('click', function (e) {
            e.preventDefault();
            gerarRelatorio('visualizar');
        });
        
        document.getElementById('btn-exportar-pdf').addEventListener('click', function (e) {
            e.preventDefault();
            gerarRelatorio('pdf');
        });
        
        document.getElementById('btn-exportar-excel').addEventListener('click', function (e) {
            e.preventDefault();
            gerarRelatorio('excel');
        });
    
        function gerarRelatorio(formato) {
            const tipo = document.getElementById('tipo-relatorio').value;
            if (!tipo) {
                alert('Selecione um tipo de relatório');
                return;
            }
    
            const form = document.getElementById('filtros-form');
            const formData = new FormData(form);
            formData.append('formato', formato);
            
            // Adicionar token CSRF
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (formato === 'visualizar') {
                // Enviar via AJAX e exibir na tela
                fetch(`/relatorios/api/${tipo}/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na resposta do servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    exibirResultadosNaTela(data);
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao gerar relatório: ' + error.message);
                });
            } else {
                // Para exportação, redirecionar para a URL de exportação
                const queryParams = new URLSearchParams(formData).toString();
                window.location.href = `/relatorios/exportar/${tipo}/${formato}/?${queryParams}`;
            }
        }
    
        function exibirResultadosNaTela(data) {
            const resultadosContainer = document.getElementById('resultados-container');
            const tabelaResultados = document.getElementById('tabela-resultados');
            const thead = tabelaResultados.querySelector('thead tr');
            const tbody = tabelaResultados.querySelector('tbody');
    
            // Limpar tabela
            thead.innerHTML = '';
            tbody.innerHTML = '';
    
            // Verificar se há dados
            if (data && data.headers && data.rows) {
                // Preencher cabeçalhos
                data.headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    thead.appendChild(th);
                });
    
                // Preencher dados
                if (data.rows.length > 0) {
                    data.rows.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell || '';
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = data.headers.length;
                    td.textContent = 'Nenhum resultado encontrado';
                    td.classList.add('text-center');
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }
            } else {
                // Se não houver dados, exibir mensagem de erro
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.textContent = 'Erro ao carregar dados do relatório';
                td.classList.add('text-center', 'text-danger');
                tr.appendChild(td);
                thead.appendChild(tr);
            }
    
            // Exibir a tabela de resultados
            resultadosContainer.style.display = 'block';
        }
    });
</script>
{% endblock %}
